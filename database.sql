create database [QL_CHTienLoi]
go
use [QL_CHTienLoi]
go
--bảng nhân viên
CREATE TABLE NHANVIEN
(
	MANV		INT PRIMARY KEY IDENTITY(1, 1), --Mã nhân viên tự tăng
	HOTEN		NVARCHAR(50),
	NGAYSINH	DATE, --Ngày sinh
	NGAYVL		DATE, --Ngày vào làm
	TENDN		CHAR(50), --tên đăng nhập
	SDT			CHAR(11),
	DIACHI		NVARCHAR(MAX)
)
--bảng loại sản phẩm
CREATE TABLE LOAISP
(
	MALOAI	INT PRIMARY KEY IDENTITY(1, 1),
	TENLOAI	NVARCHAR(50)
)
--bảng kho
CREATE TABLE PHIEUNHAP
(
	MASP	INT PRIMARY KEY IDENTITY(1,1),
	NGAYNHAP	DATE,
	SLTON	INT CHECK (SLTON >= 0),
	MANV	INT,
	GIANHAP	FLOAT CHECK (GIANHAP >= 0),
	DVT NVARCHAR(20),
	CONSTRAINT FK_PHIEUNHAP_MANV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)
--bảng sản phẩm
CREATE TABLE SANPHAM
(
	MASP	INT PRIMARY KEY,
	TENSP	NVARCHAR(100),
	MALOAI	INT,
	NGAYSX	DATE,
	NGAYHH	DATE, --Ngày hết hạn
	DONGIA	FLOAT CHECK (DONGIA > 0),
	CONSTRAINT FK_SANPHAM_MALOAI FOREIGN KEY (MALOAI) REFERENCES LOAISP(MALOAI),
	FOREIGN KEY (MASP) REFERENCES PHIEUNHAP(MASP)
)

--Bảng khách hàng
CREATE TABLE KHACHHANG
(
	MAKH	INT PRIMARY KEY IDENTITY(1, 1),
	HOTEN	NVARCHAR(50),
	SDT		CHAR(11),
	DIACHI	NVARCHAR(MAX)
)
--bảng tích điểm

--Bảng hóa đơn
CREATE TABLE HOADON
(
	MAHD	INT PRIMARY KEY IDENTITY(1, 1),
	MAKH	INT,
	MANV	INT,
	NGAYLAP	DATE DEFAULT GETDATE(),
	TRANGTHAI NVARCHAR(30) CHECK(TRANGTHAI = N'Đã xuất hóa đơn' or TRANGTHAI = N'Chưa xuất') default N'Chưa xuất',
	TIENKD	FLOAT, --Tiền khách đưa
	CONSTRAINT FK_HOADON_MAKH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
	CONSTRAINT FK_HOADON_MANV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)

--Bảng chi tiết hóa đơn
CREATE TABLE CT_HOADON
(
	MAHD	INT,
	MASP	INT,
	SOLUONG	INT,
	THANHTIEN	FLOAT,
	CONSTRAINT PK_CT_HOADON PRIMARY KEY (MAHD, MASP),
	CONSTRAINT FK_CT_HOADON_MAHD FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD),
	CONSTRAINT FK_CT_HOADON_MASP FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP),
)
--TRIGGER
--Summary: TRIGGER Này dùng để ràng buộc ngày sản xuất phải nhỏ hơn hạn sử dụng.
CREATE TRIGGER NgaySX 
ON SANPHAM
AFTER INSERT, UPDATE
AS
BEGIN
	SET NOCOUNT ON;
    IF EXISTS (
        SELECT 1
        FROM inserted
        WHERE NgaySX > NgayHH
    )
    BEGIN
        PRINT 'THÊM THẤT BẠI';
        ROLLBACK TRANSACTION;
    END
    ELSE
    BEGIN
        PRINT 'THÊM THÀNH CÔNG'; 
    END
END
SET DATEFORMAT DMY
INSERT INTO SANPHAM(NGAYSX, NGAYHH) VALUES ('20-10-2025', '20-10-2024')
update SANPHAM set NGAYSX = '20-10-2025' where MASP = 7

GO
--PROCEDURE STORE
--Xuất sản phẩm ra
CREATE PROC Select_CTHoaDon @MAHD int
AS
BEGIN 
	SELECT ct.MASP AS N'Mã sản phẩm', 
	   sp.TENSP AS N'Tên sản phẩm', 
	   sp.DONGIA AS N'Đơn giá', 
	   ct.SOLUONG as N'Số lượng', 
	   ct.SOLUONG * sp.DONGIA as N'Thành tiền'
	FROM CT_HOADON ct, SANPHAM sp
	WHERE ct.MASP = sp.MASP AND MAHD = @MAHD
END
exec Select_CTHoaDon 6
GO
--Tính tổng thành tiền
CREATE PROC Tong_ThanhTien @MAHD int
AS
BEGIN
SELECT ct.MAHD, sum(SOLUONG * DONGIA) as 'Thành tiền'
	FROM CT_HOADON ct, SANPHAM sp
	WHERE ct.MASP = sp.MASP AND MAHD = @MAHD
	GROUP BY ct.MAHD
END

exec Tong_ThanhTien 6
GO
--Xuất hóa đơn
ALTER PROC sp_XuatHoaDon @MAHD int
AS
BEGIN
	SELECT	ct.MAHD, 
			nv.HOTEN,
			hd.NGAYLAP,
			sp.TENSP, 
			ct.SOLUONG, 
			sp.DONGIA, 
			ct.SOLUONG * sp.DONGIA AS N'Thành Tiền',
			hd.TIENKD
	FROM CT_HOADON ct, HOADON hd, NHANVIEN nv, SANPHAM sp
	where ct.MAHD = hd.MAHD AND hd.MANV = nv.MANV AND sp.MASP = ct.MASP AND ct.MAHD = @MAHD
END
--FUNCTION
--QUERY

-- Data
USE [QL_CHTienLoi]
GO
SET IDENTITY_INSERT [dbo].[LOAISP] ON 

INSERT [dbo].[LOAISP] ([MALOAI], [TENLOAI]) VALUES (1, N'Nước giải khát')
INSERT [dbo].[LOAISP] ([MALOAI], [TENLOAI]) VALUES (2, N'Chứa cồn')
INSERT [dbo].[LOAISP] ([MALOAI], [TENLOAI]) VALUES (3, N'Gia dụng')
INSERT [dbo].[LOAISP] ([MALOAI], [TENLOAI]) VALUES (4, N'Sữa')
INSERT [dbo].[LOAISP] ([MALOAI], [TENLOAI]) VALUES (5, N'Đồ ăn nhanh')
INSERT [dbo].[LOAISP] ([MALOAI], [TENLOAI]) VALUES (6, N'Văn phòng phẩm')
INSERT [dbo].[LOAISP] ([MALOAI], [TENLOAI]) VALUES (7, N'Bim Bim và các loại bánh')
INSERT [dbo].[LOAISP] ([MALOAI], [TENLOAI]) VALUES (8, N'Đồ chơi trẻ em')
SET IDENTITY_INSERT [dbo].[LOAISP] OFF
GO
SET IDENTITY_INSERT [dbo].[NHANVIEN] ON 

INSERT [dbo].[NHANVIEN] ([MANV], [HOTEN], [NGAYSINH], [NGAYVL], [TENDN], [SDT], [DIACHI]) VALUES (1, N'Huỳnh Thế Bảo', CAST(N'2002-10-20' AS Date), CAST(N'2020-08-03' AS Date), N'AdminQL                                           ', N'0334661938 ', N'Tây Thạnh-Tân Phú')
INSERT [dbo].[NHANVIEN] ([MANV], [HOTEN], [NGAYSINH], [NGAYVL], [TENDN], [SDT], [DIACHI]) VALUES (2, N'Nguyễn Phi Xuân Hùng', CAST(N'2002-01-01' AS Date), CAST(N'2021-03-01' AS Date), N'Hungnpx                                           ', N'0334989212 ', N'Tuy Hòa - Phú Yên')
SET IDENTITY_INSERT [dbo].[NHANVIEN] OFF
GO
SET IDENTITY_INSERT [dbo].[PHIEUNHAP] ON 

INSERT [dbo].[PHIEUNHAP] ([MASP], [NGAYNHAP], [SLTON], [MANV], [GIANHAP], [DVT]) VALUES (1, CAST(N'2024-07-18' AS Date), 20, 1, 30000, N'Thùng')
INSERT [dbo].[PHIEUNHAP] ([MASP], [NGAYNHAP], [SLTON], [MANV], [GIANHAP], [DVT]) VALUES (2, CAST(N'2024-07-18' AS Date), 200, 1, 10000, N'Chai')
INSERT [dbo].[PHIEUNHAP] ([MASP], [NGAYNHAP], [SLTON], [MANV], [GIANHAP], [DVT]) VALUES (3, CAST(N'2024-07-18' AS Date), 150, 1, 11000, N'Cây')
SET IDENTITY_INSERT [dbo].[PHIEUNHAP] OFF
GO
INSERT [dbo].[SANPHAM] ([MASP], [TENSP], [MALOAI], [NGAYSX], [NGAYHH], [DONGIA]) VALUES (1, N'Coca CoLa', 1, CAST(N'2023-07-25' AS Date), CAST(N'2025-10-07' AS Date), 15000)
INSERT [dbo].[SANPHAM] ([MASP], [TENSP], [MALOAI], [NGAYSX], [NGAYHH], [DONGIA]) VALUES (2, N'Sting', 1, CAST(N'2024-07-07' AS Date), CAST(N'2026-07-07' AS Date), 15000)
INSERT [dbo].[SANPHAM] ([MASP], [TENSP], [MALOAI], [NGAYSX], [NGAYHH], [DONGIA]) VALUES (3, N'Bút chì', 6, CAST(N'2023-07-09' AS Date), CAST(N'2030-09-09' AS Date), 14000)
GO
SET IDENTITY_INSERT [dbo].[KHACHHANG] ON 

INSERT [dbo].[KHACHHANG] ([MAKH], [HOTEN], [SDT], [DIACHI]) VALUES (1, N'Vãng Lai', N'0000       ', N'Không xác định')
INSERT [dbo].[KHACHHANG] ([MAKH], [HOTEN], [SDT], [DIACHI]) VALUES (2, N'Huỳnh Thế Bảo', N'0334661938 ', N'Long An')
SET IDENTITY_INSERT [dbo].[KHACHHANG] OFF
GO
SET IDENTITY_INSERT [dbo].[HOADON] ON 

INSERT [dbo].[HOADON] ([MAHD], [MAKH], [MANV], [NGAYLAP], [TIENKD], [TRANGTHAI]) VALUES (1, 1, 1, CAST(N'2024-07-29' AS Date), NULL, NULL)
INSERT [dbo].[HOADON] ([MAHD], [MAKH], [MANV], [NGAYLAP], [TIENKD], [TRANGTHAI]) VALUES (3, 1, 1, CAST(N'2024-07-29' AS Date), NULL, N'Chưa xuất')
INSERT [dbo].[HOADON] ([MAHD], [MAKH], [MANV], [NGAYLAP], [TIENKD], [TRANGTHAI]) VALUES (4, 1, 1, CAST(N'2024-07-29' AS Date), NULL, N'Chưa xuất')
INSERT [dbo].[HOADON] ([MAHD], [MAKH], [MANV], [NGAYLAP], [TIENKD], [TRANGTHAI]) VALUES (5, 1, 1, CAST(N'2024-07-29' AS Date), NULL, N'Chưa xuất')
INSERT [dbo].[HOADON] ([MAHD], [MAKH], [MANV], [NGAYLAP], [TIENKD], [TRANGTHAI]) VALUES (6, 1, 1, CAST(N'2024-07-29' AS Date), NULL, N'Chưa xuất')
INSERT [dbo].[HOADON] ([MAHD], [MAKH], [MANV], [NGAYLAP], [TIENKD], [TRANGTHAI]) VALUES (7, 1, 1, CAST(N'2024-07-29' AS Date), NULL, N'Chưa xuất')
INSERT [dbo].[HOADON] ([MAHD], [MAKH], [MANV], [NGAYLAP], [TIENKD], [TRANGTHAI]) VALUES (8, 1, 1, CAST(N'2024-07-29' AS Date), NULL, N'Chưa xuất')
INSERT [dbo].[HOADON] ([MAHD], [MAKH], [MANV], [NGAYLAP], [TIENKD], [TRANGTHAI]) VALUES (9, 1, 1, CAST(N'2024-07-29' AS Date), NULL, N'Chưa xuất')
INSERT [dbo].[HOADON] ([MAHD], [MAKH], [MANV], [NGAYLAP], [TIENKD], [TRANGTHAI]) VALUES (10, 1, 1, CAST(N'2024-07-29' AS Date), NULL, N'Chưa xuất')
INSERT [dbo].[HOADON] ([MAHD], [MAKH], [MANV], [NGAYLAP], [TIENKD], [TRANGTHAI]) VALUES (12, 1, 1, CAST(N'2024-07-29' AS Date), NULL, N'Chưa xuất')
INSERT [dbo].[HOADON] ([MAHD], [MAKH], [MANV], [NGAYLAP], [TIENKD], [TRANGTHAI]) VALUES (15, 1, 1, CAST(N'2024-07-29' AS Date), NULL, N'Chưa xuất')
SET IDENTITY_INSERT [dbo].[HOADON] OFF
GO
INSERT [dbo].[CT_HOADON] ([MAHD], [MASP], [SOLUONG], [THANHTIEN]) VALUES (15, 1, 3, NULL)
GO

--DROP TABLE  HOADON
--DROP TABLE CT_HOADON
--DROP TABLE KHACHHANG
--DROP TABLE NHANVIEN
--DROP TABLE LOAISP
--drop TABLE SANPHAM
--DROP FK_SANPHAM_MALOAI

--SECURITY 
CREATE TABLE MANHINH
(
	ID	INT PRIMARY KEY IDENTITY(1, 1),
	TENMH	NVARCHAR(100),
	USERROLE	NVARCHAR(30)
)
CREATE TABLE 

--Authentication and Authorize
CREATE ROLE _ADMIN
GRANT SELECT, INSERT, UPDATE, DELETE TO _ADMIN
GO
CREATE ROLE _NVTHUNGAN
GO
CREATE ROLE _NVKIEMKE
GO

--CREATE LOGIN AdminQL WITH PASSWORD = '123'
--CREATE USER AdminQL FOR LOGIN[AdminQL]
