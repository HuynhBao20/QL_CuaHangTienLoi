create database [QL_CHTienLoi]
go
use [QL_CHTienLoi]
go
--bảng nhân viên
CREATE TABLE NHANVIEN
(
	MANV		INT PRIMARY KEY IDENTITY(1, 1), --Mã nhân viên tự tăng
	HOTEN		NVARCHAR(50),
	NGAYSINH	DATE, --Ngày sinh
	NGAYVL		DATE, --Ngày vào làm
	TENDN		CHAR(50), --tên đăng nhập
	SDT			CHAR(11),
	DIACHI		NVARCHAR(MAX)
)
--bảng loại sản phẩm
CREATE TABLE LOAISP
(
	MALOAI	INT PRIMARY KEY IDENTITY(1, 1),
	TENLOAI	NVARCHAR(50)
)
--bảng kho
CREATE TABLE PHIEUNHAP
(
	MASP	INT PRIMARY KEY IDENTITY(1,1),
	NGAYNHAP	DATE,
	SLTON	INT CHECK (SLTON >= 0),
	MANV	INT,
	GIANHAP	FLOAT CHECK (GIANHAP >= 0),
	DVT NVARCHAR(20),
	CONSTRAINT FK_PHIEUNHAP_MANV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)
ALTER TABLE PHIEUNHAP
ADD 
--bảng sản phẩm
CREATE TABLE SANPHAM
(
	MASP	INT PRIMARY KEY,
	TENSP	NVARCHAR(100),
	MALOAI	INT,
	NGAYSX	DATE,
	NGAYHH	DATE, --Ngày hết hạn
	DONGIA	FLOAT CHECK (DONGIA > 0),
	CONSTRAINT FK_SANPHAM_MALOAI FOREIGN KEY (MALOAI) REFERENCES LOAISP(MALOAI),
	FOREIGN KEY (MASP) REFERENCES PHIEUNHAP(MASP)
)

--Bảng khách hàng
CREATE TABLE KHACHHANG
(
	MAKH	INT PRIMARY KEY IDENTITY(1, 1),
	HOTEN	NVARCHAR(50),
	SDT		CHAR(11),
	DIACHI	NVARCHAR(MAX)
)
--bảng tích điểm

--Bảng hóa đơn
CREATE TABLE HOADON
(
	MAHD	INT PRIMARY KEY IDENTITY(1, 1),
	MAKH	INT,
	MANV	INT,
	NGAYLAP	DATE DEFAULT GETDATE(),
	TIENKD	FLOAT, --Tiền khách đưa
	CONSTRAINT FK_HOADON_MAKH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
	CONSTRAINT FK_HOADON_MANV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)
--Bảng chi tiết hóa đơn
CREATE TABLE CT_HOADON
(
	MAHD	INT,
	MASP	INT,
	SOLUONG	INT,
	THANHTIEN	FLOAT,
	CONSTRAINT PK_CT_HOADON PRIMARY KEY (MAHD, MASP),
	CONSTRAINT FK_CT_HOADON_MAHD FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD),
	CONSTRAINT FK_CT_HOADON_MASP FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP),
)
--TRIGGER
--Summary: TRIGGER Này dùng để ràng buộc ngày sản xuất phải nhỏ hơn hạn sử dụng.
CREATE TRIGGER NgaySX 
ON SANPHAM
AFTER INSERT, UPDATE
AS
BEGIN
	SET NOCOUNT ON;
    IF EXISTS (
        SELECT 1
        FROM inserted
        WHERE NgaySX > NgayHH
    )
    BEGIN
        PRINT 'THÊM THẤT BẠI';
        ROLLBACK TRANSACTION;
    END
    ELSE
    BEGIN
        PRINT 'THÊM THÀNH CÔNG';
        -- No need to commit transaction as it is handled automatically
    END
END
SET DATEFORMAT DMY
INSERT INTO SANPHAM(NGAYSX, NGAYHH) VALUES ('20-10-2025', '20-10-2024')
update SANPHAM set NGAYSX = '20-10-2025' where MASP = 7


--PROCEDURE STORE
--FUNCTION
--QUERY


DROP TABLE  HOADON
DROP TABLE CT_HOADON
DROP TABLE KHACHHANG
DROP TABLE NHANVIEN
DROP TABLE LOAISP
drop TABLE SANPHAM
DROP FK_SANPHAM_MALOAI